using Columns.Game;
using System.Diagnostics;
using System.Xml.Linq;

namespace ColumnsTest
{
    /// <summary>
    /// “есты дл€ игры
    /// </summary>
    [TestClass]
    public class ColumnsTest
    {

        /// <summary>
        /// »нициализаци€ игры
        /// </summary>
        /// <returns></returns>
        private GameField InitColumns()
        {
            GameField gameField = new GameField();
            gameField.OnGameOver += () => { };
            gameField.OnRedraw += () => { };
            return gameField;
        }


        /// <summary>
        /// ѕроверка флага окончани€ игры на false при инициализации игры
        /// </summary>
        [TestMethod]
        public void TestInitGameAndFalseFlafIsGameEnd()
        {
            GameField gameField = InitColumns();
            Assert.IsFalse(gameField.IsGameEnd);
        }

        /// <summary>
        /// ѕроверка флага обновлени€ полей на true при инициализации игры
        /// </summary>
        [TestMethod]
        public void TestInitGameAndTrueFlagIsFieldsUpdated()
        {
            GameField gameField = InitColumns();
            Assert.IsTrue(gameField.IsFieldsUpdated);
        }

        /// <summary>
        /// ѕроверка флага на завершение игры на false при старте игры
        /// </summary>
        [TestMethod]
        public void TestStartGameAndFlagIsGameEndFalse()
        {
            GameField gameField = InitColumns();
            gameField.Start();
            Assert.AreEqual(false, gameField.IsGameEnd);
        }

        /// <summary>
        /// ѕроверка флага дл€ запуска нового блока на несоотвествие true при запуске нового блока
        /// </summary>
        [TestMethod]
        public void TestStartRunBlokcGameAndNotEqualFlagStartNewBlockAllow()
        {
            GameField gameField = InitColumns();
            gameField.StartRunBlock();
            Assert.AreNotEqual(true, gameField.StartNewBlockAllow);
        }

        /// <summary>
        /// ѕроверка флага окончани€ игры на несоответствие true при инициализации игры
        /// </summary>
        [TestMethod]
        public void TestFlagIsGameEndAreNotEqual()
        {
            GameField gameField = InitColumns();
            Assert.AreNotEqual(true, gameField.IsGameEnd);
        }


        /// <summary>
        /// ѕроверка количества очков равно шести при наличии в одной строке шести €чеек одинакового цвета
        /// </summary>
        [TestMethod]
        public void TestScoreqWhenBurningSixCellsIsOneColumn()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 1;
            cells[1, 2] = 1;
            cells[1, 3] = 1;
            cells[1, 4] = 1;
            cells[1, 5] = 1;
            cells[1, 6] = 1;
            gameField.Fields = cells;
            gameField.DeleteEqualsFields();
            Assert.AreEqual(6, gameField.Score);
        }

        /// <summary>
        /// ѕроверка на несоответствие количества набранных очков, равное четырЄм при €чейках в первой строке разного цвета
        /// </summary>
        [TestMethod]
        public void TestAreNotEqualScoreWhenInOneLineFiguresDifferentColors()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 1;
            cells[1, 2] = 2;
            cells[1, 3] = 3;
            cells[1, 4] = 1;
            cells[1, 5] = 1;
            cells[1, 6] = 1;
            gameField.Fields = cells;
            gameField.DeleteEqualsFields();
            Assert.AreNotEqual(4, gameField.Score);
        }

        /// <summary>
        /// ѕроверка на сгорание €чеек из трех строк разных цветов, но попарно одинаковых и набираение количества дев€ти очков
        /// </summary>
        [TestMethod]
        public void TestCheckBurningCellFirstWayAndGetingNineScore()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 1;
            cells[1, 2] = 2;
            cells[1, 3] = 3;
            cells[2, 1] = 1;
            cells[2, 2] = 2;
            cells[2, 3] = 3;
            cells[3, 1] = 1;
            cells[3, 2] = 2;
            cells[3, 3] = 3;
            gameField.Fields = cells;
            gameField.DeleteEqualsFields();
            Assert.AreEqual(9, gameField.Score);
        }

        /// <summary>
        /// ѕроверка на сгорание €чеек из трех строк одинакового цвета и набираение количества дев€ти очков
        /// </summary>
        [TestMethod]
        public void TestCheckBurningSecondWayAndGetingNineScore()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 1;
            cells[1, 2] = 1;
            cells[1, 3] = 1;
            cells[2, 1] = 1;
            cells[2, 2] = 1;
            cells[2, 3] = 1;
            cells[3, 1] = 1;
            cells[3, 2] = 1;
            cells[3, 3] = 1;
            gameField.Fields = cells;
            gameField.DeleteEqualsFields();
            Assert.AreEqual(9, gameField.Score);
        }


        /// <summary>
        /// ѕроверка на сгорание двух блоков из трЄх €чеек одинакового цвета и получение значений основного пол€ равных нулю
        /// </summary>
        [TestMethod]
        public void TestCheckerNullValuesInFieldsWhenFirstRowWithBlocksOfTheSameColor()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 1;
            cells[1, 2] = 1;
            cells[1, 3] = 1;
            cells[1, 4] = 1;
            cells[1, 5] = 1;
            cells[1, 6] = 1;
            gameField.Fields = cells;
            gameField.DeleteEqualsFields();
            Assert.IsTrue(checkDoubleArrayInNullValues(gameField.Fields, GameField.Columns, GameField.Rows));
        }

        /// <summary>
        /// ѕроверка сгорани€ в одной строке €чеек разных цветов
        /// </summary>
        [TestMethod]
        public void TestCheckerNullValuesInFieldsWhenFirstRowWithBlocksOfDifferentColors()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 1;
            cells[1, 2] = 2;
            cells[1, 3] = 1;
            cells[1, 4] = 1;
            cells[1, 5] = 3;
            cells[1, 6] = 1;
            gameField.Fields = cells;
            gameField.DeleteEqualsFields();
            Assert.IsFalse(checkDoubleArrayInNullValues(gameField.Fields, GameField.Columns, GameField.Rows));
        }

        /// <summary>
        /// ѕроверка сгорани€ блоков из трех р€дов и получени€ значений массива основного пол€
        /// </summary>
        [TestMethod]
        public void TestCheckerNullValuesWhenThreeRowsFilledWithCellsOfDifferentColorOnPairs()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 1;
            cells[1, 2] = 2;
            cells[1, 3] = 3;
            cells[2, 1] = 1;
            cells[2, 2] = 2;
            cells[2, 3] = 3;
            cells[3, 1] = 1;
            cells[3, 2] = 2;
            cells[3, 3] = 3;
            gameField.Fields = cells;
            gameField.DeleteEqualsFields();
            Assert.IsTrue(checkDoubleArrayInNullValues(gameField.Fields, GameField.Columns, GameField.Rows));
        }

        /// <summary>
        /// ѕроверка сгорани€ блоков, сто€щих друг под другом разных цветов и получени€ значений массива основного пол€
        /// </summary>
        [TestMethod]
        public void TestCheckerCorrectsDeletingFieldsAndCheckerNullValues()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 1;
            cells[1, 2] = 2;
            cells[1, 3] = 3;
            cells[2, 1] = 1;
            cells[2, 2] = 2;
            cells[2, 3] = 3;
            cells[3, 1] = 1;
            cells[3, 2] = 2;
            cells[3, 3] = 3;
            gameField.Fields = cells;
            gameField.DeleteEqualsFields();
            Assert.IsTrue(checkDoubleArrayInNullValues(gameField.Fields, GameField.Columns, GameField.Rows));
        }

        /// <summary>
        /// ѕроверка корректного перемещени€ блока влева и изменени€ значени€ его колонки движени€
        /// </summary>
        [TestMethod]
        public void TestCheckerCorrectMethodMoveToTheLeft()
        {
            GameField gameField = InitColumns();
            gameField.MoveToTheLeft();
            Assert.AreEqual(3, gameField.Column);
        }

        /// <summary>
        /// ѕроверка правильности работы метода обновлени€ основного массива из вспомогательного
        /// </summary>
        [TestMethod]
        public void TestCheckerTheCorrectnessMethodUpdateNFieldsFromNewFields()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 1;
            cells[1, 2] = 2;
            cells[1, 3] = 3;
            gameField.Fields = cells;
            gameField.UpdateFieldsFromNewFields();
            Assert.AreEqual(gameField.Fields.ToString(), gameField.NewFields.ToString());
        }


        /// <summary>
        /// ѕроверка правильности работы метода обновлени€ вспомогательного массива из основного
        /// </summary>
        [TestMethod]
        public void TestCheckerTheCorrectnessMethodUpdateNewFieldsFromFields()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 3;
            cells[1, 2] = 2;
            cells[1, 3] = 1;
            gameField.NewFields = cells;
            gameField.UpdateNewFieldsFromFields();
            Assert.AreEqual(gameField.NewFields.ToString(), gameField.Fields.ToString());
        }

        /// <summary>
        /// ѕроверка изменени€ вспомогательного массива и удалени€ элементов на соответствие значений вспомогательного массива нулю
        /// </summary>
        [TestMethod]
        public void TestCheckerSeveralNewFiledsAndCheckingTheirValuesAreEqualNull()
        {
            GameField gameField = InitColumns();
            int[,] cells = new int[GameField.Columns, GameField.Rows];
            cells[1, 1] = 3;
            cells[1, 2] = 2;
            cells[1, 3] = 1;
            gameField.NewFields = cells;
            int[,] cells1 = new int[GameField.Columns, GameField.Rows];
            cells[2, 1] = 3;
            cells[2, 2] = 2;
            cells[2, 3] = 1;
            gameField.NewFields = cells1;
            int[,] cells2 = new int[GameField.Columns, GameField.Rows];
            cells[3, 1] = 3;
            cells[3, 2] = 2;
            cells[3, 3] = 1;
            gameField.NewFields = cells2;
            gameField.DeleteEqualsFieldsInNewFields();
            Assert.AreEqual(true, checkDoubleArrayInNullValues(gameField.NewFields, GameField.Columns, GameField.Rows));
        }

        /// <summary>
        /// ѕроверка генерации блока и соответствие значению false метода проверки массива на нулевые значени€
        /// </summary>
        [TestMethod]
        public void TestGenerateBlocAndNotNullValuesNewBlockGeneration()
        {
            GameField gameField = InitColumns();
            gameField.GenerateBlock();
            Assert.IsFalse(checkArrayInNullValues(gameField.NewBlock));
        }

        /// <summary>
        /// ѕроверка корректности изменени€ флага дл€ нажати€ кнопки при изменени€ движени€ влево
        /// </summary>

        [TestMethod]
        public void TestCorrectFlagIfButtonPressedAtKeyDirectionLeft()
        {
            GameField gameField = InitColumns();
            gameField.Move(KeyDirection.Left);
            Assert.IsTrue(gameField.IfButtonPressed);
        }


        /// <summary>
        /// ѕроверка метода перемещени€ вправо и соответстви€ изменени€ свойства по направлению нажати€
        /// </summary>
        [TestMethod]
        public void TestMoveCorrectDirectionRight()
        {
            GameField gameField = InitColumns();
            gameField.Move(KeyDirection.Right);
            Assert.AreEqual(KeyDirection.Right, gameField.Key);
        }

        /// <summary>
        /// ѕроверка всех значений значений массива на равенство нулю
        /// </summary>
        /// <param name="parNewBlock">Ќовый блок</param>
        /// <returns>«аполнен ли массив нул€ми либо нет</returns>
        private bool checkArrayInNullValues(int[] parNewBlock)
        {
            for (int i = 0; i < parNewBlock.Length; i++)
            {
                if (parNewBlock[i] == 0)
                {
                    return true;
                }
            }
            return false;
        }

        /// <summary>
        /// ѕроверка всех значений двухмерного массива на равенство нулю
        /// </summary>
        /// <param name="parArray">¬ходной массив</param>
        /// <param name="parColumns">—толбцы</param>
        /// <param name="parRows">–€ды</param>
        /// <returns>«аполнен ли двухмерный массив нул€ми либо нет</returns>
        private bool checkDoubleArrayInNullValues
            (int[,] parArray, int parColumns, int parRows)
        {
            for (int i = 0; i < parArray.Length / parRows; i++)
            {
                for (int j = 0; j < parArray.Length / parColumns; j++)
                {
                    if (parArray[i, j] != 0)
                    {
                        return false;
                    }
                }
            }
            return true;
        }
    }
}